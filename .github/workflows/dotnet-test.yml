name: Account service tests

on:
    push:
        branches: [ master ]
    pull_request:
        branches: [ master ]
jobs:
  test:
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:dind
        options: --privileged

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: "9.0.x"

    - name: Pre-pull PostgreSQL 16.2
      run: docker pull postgres:16.2

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --no-restore --configuration Release

    - name: Run tests
      run: dotnet test --no-build --verbosity normal
      env:
        DOCKER_HOST: tcp://localhost:2375
        POSTGRES_HOST: localhost
        POSTGRES_PORT: 5432

    - name: Docker cleanup (optional)
      if: always()
      run: |
        docker ps -aq | xargs docker rm -f || true